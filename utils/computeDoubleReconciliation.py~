# -*- coding: utf-8 -*-
from shutil import copyfile
import argparse
from ete3 import PhyloTree
import copy
import os


def build_arg_parser():
	parser = argparse.ArgumentParser(description="Compute Double Reconciliation")
	parser.add_argument('-id', '--genefamilyid')
	return parser

def reduceLeaveName(tree, car):
	dictSpe = {}
	dictSpeInv = {}
	compt = 10
	for node in tree.traverse("preorder"):
		if node.is_leaf():
			var = car + str(compt)
			compt = compt + 1
			dictSpe[node.name] = var
			dictSpeInv[var] = node.name
			node.name = var
	return tree, dictSpe, dictSpeInv

def pruneSpeciesTree(gene_familly_id):
	gene_tree_f = open("SuperProteinTree/datas/" + gene_familly_id + "_genetree.nw", "r")
	gene_tree_content = gene_tree_f.readlines()[0]
	gene_tree = PhyloTree(gene_tree_content)
	gene_leaves = gene_tree.get_leaf_names()

	transcrit_tree_f = open("SuperProteinTree/output/" + gene_familly_id + "_superProteinTree.nw", "r")
	transcrit_content = transcrit_tree_f.readlines()[0]
	transcrit_tree = PhyloTree(transcrit_content)
	
	protein2gene = {}
	gene2specie = {}
	specieslist = []
	trans2gene2species = open("SHT/tmp/" + gene_familly_id + "_mapping_transcript.txt", "r")
	lines = trans2gene2species.readlines()
	for l in lines:	
		l = l.replace("\n", "")
		p = l.split("\t")		
		if p[2] in gene_leaves:
			protein2gene[p[1]] = p[2]
			gene2specie[p[2]] = p[3]
			specieslist.append(p[3])
	speciesTree_f = open("SHT/ressources/ensemblSpecies.tree", "r")
	speciesTree_content = speciesTree_f.readlines()[0]
	speciesTree_content = speciesTree_content.replace("*", "")
	speciesTree = PhyloTree(speciesTree_content, quoted_node_names=False, format=1)
	speciesTree.prune(specieslist)
	file = open("SuperProteinTree/datas/" + gene_familly_id + "_speciesTree.nw","w")
	file.write(speciesTree.write(format=9))

	gene_tree_to_print = copy.deepcopy(gene_tree)
	for node in gene_tree_to_print:
		if node.is_leaf():						
			node.name = gene2specie[node.name] + "_" + node.name
	
	transcript_tree_to_print = copy.deepcopy(transcrit_tree)
	for node in transcript_tree_to_print:
		if node.is_leaf():						
			node.name = protein2gene[node.name] + "_" + node.name
	

	transcrit_tree_label = copy.deepcopy(transcrit_tree)
	gene_tree_label = copy.deepcopy(gene_tree)
	species_tree_label = copy.deepcopy(speciesTree)
	
	transcrit_tree_label, dictTrans, dictTransInv = reduceLeaveName(copy.deepcopy(transcrit_tree_label), "T")
	gene_tree_newname, dictGene, dictGeneInv = reduceLeaveName(copy.deepcopy(gene_tree_label), "G")
	species_tree_new_name, dictSpecies, dictSpeciesInv = reduceLeaveName(species_tree_label, "S")
	
	for node in transcrit_tree_label.traverse("postorder"):
		if node.is_leaf():
			node.name =  dictGene[protein2gene[dictTransInv[node.name]]] + "_" + node.name

	gene_tree_newname_label = copy.deepcopy(gene_tree_newname)
	for node in gene_tree_newname.traverse("postorder"):	
		if node.is_leaf():
			node.name = dictSpecies[gene2specie[dictGeneInv[node.name]]]  + "_" + node.name

	return gene_tree_to_print, transcript_tree_to_print, dictTrans, dictTransInv, dictGene, dictGeneInv, dictSpecies, dictSpeciesInv, transcrit_tree, transcrit_tree_label, gene_tree_newname_label,  gene_tree, gene_tree_newname, speciesTree, species_tree_new_name

def doubleReconciliation(dictTrans, dictTransInv, dictGene, dictGeneInv, dictSpecies, dictSpeciesInv,transcrit_tree, transcrit_tree_label, gene_tree_newname_label, gene_tree, gene_tree_newname, speciesTree, species_tree_new_name, genefamilyid):
	recon_tree_transcript_gene, events_transcript_gene = transcrit_tree_label.reconcile(gene_tree_newname_label)

	for node in recon_tree_transcript_gene:
		if node.is_leaf():
			p = node.name.split("_")
			if len(p) == 1:
				node.name = dictGeneInv[p[0]]
			elif len(p) == 2:
				node.name = dictGeneInv[p[0]] + "_" + dictTransInv[p[1]]
	print(recon_tree_transcript_gene)
	file = open("Output/" + genefamilyid + "/" + genefamilyid + "_reconciliation_transcripts_genes.nw","w")
	file.write(recon_tree_transcript_gene.write(format=9))

	recon_tree_gene_species, events_gene_species = gene_tree_newname.reconcile(species_tree_new_name)
	for node in recon_tree_gene_species:
		if node.is_leaf():
			p = node.name.split("_")
			if len(p) == 1:
				node.name = dictSpeciesInv[p[0]]
			elif len(p) == 2:
				node.name = dictSpeciesInv[p[0]] + "_" + dictGeneInv[p[1]]
	print(recon_tree_gene_species)
	file = open("Output/" + genefamilyid + "/" + genefamilyid + "_reconciliation_genes_species.nw","w")
	file.write(recon_tree_gene_species.write(format=9))
	return recon_tree_transcript_gene, events_transcript_gene, recon_tree_gene_species, events_gene_species

def generatetab(nb):
	tab = ""
	for i in range(nb):
		tab += "\t"
	return tab

def completeSpeciesTree(tree):
	tree = "<spTree>\n \t<phylogeny>"  + tree + "</spTree>\n \t</phylogeny>"
	return tree

def convert_species_tree(tree, i):
	
	if 	tree.is_root():
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i) + "<name>" +  tree.name  +"</name>")
		children = tree.children
		for n in children:
			convert_species_tree(n, i+1)
		print(generatetab(i-1) + "</clade>")
	elif tree.is_leaf():
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i) + "<name>" +  tree.name  +"</name>")
		print(generatetab(i-1) + "</clade>")
	else:
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i-1) + "<name>" +  tree.name  +"</name>")
		children = tree.children
		for n in children:
			convert_species_tree(n, i+1)
		print(generatetab(i) + "</clade>")		

def is_loss(tree):
	leaves = tree.get_leaf_names()
	flag = True
	for e in leaves:
		if len(e.split("_")) != 1:
			flag = False
	return flag

def is_leaf(tree):
	leaves = tree.get_leaf_names()
	flag = True
	if len(leaves) == 1 and len(leaves[0].split("_")) == 0:
		return True
	else:
		return False
	

def eventtype(node):

	return "speciation"

def convert_rec_gene_species_tree(tree, i):
	
	if 	tree.is_root():
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i) + "<name>" +  tree.name  +"</name>")
		print(generatetab(i) + "<eventsRec>")

		print(generatetab(i+1) + "<" + eventtype(tree) +" speciesLocation=\"" +  tree.name + "\"></"+eventtype(tree)+">")
		print(generatetab(i) + "</eventsRec>")

		children = tree.children
		for n in children:
			convert_rec_gene_species_tree(n, i+1)
		print(generatetab(i-1) + "</clade>")
	elif is_leaf(tree):
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i) + "<name>" +  tree.name  +"</name>")
		print(generatetab(i) + "<eventsRec>")

		print(generatetab(i+1) + "<leaf speciesLocation=\"" +  tree.name + "\"/>")
		print(generatetab(i) + "</eventsRec>")

		print(generatetab(i-1) + "</clade>")
	elif is_loss(tree):
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i) + "<name> - </name>")
		print(generatetab(i) + "<eventsRec>")

		print(generatetab(i+1) + "<loss speciesLocation=\"" +  tree.name + "\"></loss>" )
		print(generatetab(i) + "</eventsRec>")

		print(generatetab(i-1) + "</clade>")		
	else:
		print(generatetab(i-1) + "<clade>")
		print(generatetab(i-1) + "<name>" +  tree.name  +"</name>")
		print(generatetab(i) + "<eventsRec>")

		print(generatetab(i+1) + "<" + eventtype(tree) +" speciesLocation=\"" +  tree.name + "\"></"+eventtype(tree)+">")
		print(generatetab(i) + "</eventsRec>")

		children = tree.children
		for n in children:
			convert_rec_gene_species_tree(n, i+1)
		print(generatetab(i) + "</clade>")		


def addName(tree):
	i = 1
	for n in tree.traverse('postorder'):
		print(n.name)
		if n.name == "":
			n.name = str(i)
			i += 1
	return tree

def main():
	parser = build_arg_parser()
	arg = parser.parse_args()
	genefamilyid = arg.genefamilyid
	try: 
		if not(os.path.isdir(genefamilyid)):
			os.mkdir("Output/" + genefamilyid)
	except OSError as error: 
		pass

	gene_tree_to_print, transcript_tree_to_print,dictTrans, dictTransInv, dictGene, dictGeneInv, dictSpecies, dictSpeciesInv, transcrit_tree, transcrit_tree_label, gene_tree_newname_label,  gene_tree, gene_tree_newname, speciesTree, species_tree_new_name = pruneSpeciesTree(genefamilyid)
	
	recon_tree_transcript_gene, events_transcript_gene, recon_tree_gene_species, events_gene_species = doubleReconciliation(dictTrans, dictTransInv, dictGene, dictGeneInv, dictSpecies, dictSpeciesInv,transcrit_tree, transcrit_tree_label, gene_tree_newname_label, gene_tree, gene_tree_newname, speciesTree, species_tree_new_name, genefamilyid)
	print("__________________________________________________\n\n\n")	
	#recon_tree_gene_species = addName(recon_tree_gene_species)
	print(speciesTree)
	convert_species_tree(speciesTree, 2)
	convert_rec_gene_species_tree(recon_tree_transcript_gene, 2)

if __name__ == "__main__":
	main()

